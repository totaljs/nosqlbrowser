@{layout('')}
@{title('NoSQL embedded database')}

<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=11" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<meta name="robots" content="all,follow" />
	<link rel="stylesheet" href="//cdn.componentator.com/spa.min@15.css" />
	<script src="//cdn.componentator.com/spa.min@15.js"></script>
	@{import('meta', 'head', 'default.css', 'default.js', 'favicon.ico')}
</head>
<body data-jc="exec">

	<div data-jc="LAZY confirm"></div>
	<div data-jc="loading" class="hidden"></div>

	<div class="padding" style="padding-bottom:0">
		<nav class="toolbar" data-bind="browser.rows__show .filled:value instanceof Array">
			<div class="hidden info filled">
				<span data-bind="browser.filename__text:value"></span> / <b data-bind="browser.rows__!html:value.length.pluralize(@('#Â documents', '# document', '# documents', '# documents'))"></b>
			</div>
			<button name="open" data-jc="filebrowser__null__exec:browser/process"><i class="fa fa-folder-o"></i>@(Open)</button>
			<button name="save" class="hidden filled exec" data-exec="browser/save"><i class="fa fa-floppy-o"></i>@(Save)</button>
			<span></span>
			<button name="remove" class="hidden filled exec" data-bind="browser.checked__show:value && value.length > 0" data-exec="browser/remove"><i class="fa fa-times-circle"></i>@(Remove rows)</button>
		</nav>
	</div>

	<div data-jc="dragdropfiles__null__exec:browser/process" class="dragdrop" data-bind="browser.open__show:value == null"><div><i class="fa fa-database fa-3x"></i><br /><br />@(<b>Drag &amp; Drop</b><br />NoSQL database or NoSQL binary file)</div></div>

	<div class="padding" data-bind="browser.binary__show:value != null__!template">
		<script type="text/html">
			<div class="row">
				<div class="col-md-4 col-md-offset-4">
					<table class="table table-bordered">
						<tr>
							<td class="b"><i class="far fa-file mr5"></i>{{ value.name }}</td>
						</tr>
						<tr>
							<td>{{ value.type }}</td>
						</tr>
						{{ if value.width && value.height }}
						<tr>
							<td>{{ value.width }}x{{ value.height }} @(pixels)</td>
						</tr>
						{{ fi }}
						{{ if value.custom }}
						<tr>
							<td>{{ value.custom }}</td>
						</tr>
						{{ fi }}
						<tr>
							<td><a href="javascript:void(0)" class="exec" data-exec="browser/download">@(Download file) ({{ value.size | filesize }})</a></td>
						</tr>
					</table>
				</div>
			</div>
			<div><img src="data:{{ value.type }};base64,{{ value.data | raw }}" class="img-responsive" alt="{{ value.name }}" style="margin:0 auto" /></div>
		</script>
	</div>

	<div class="padding" data-bind="browser.rows__show:value != null" style="padding-top:0">
		<div data-jc="datagrid__browser.rows__click:browser/detail;colwidth:180;checked:browser.checked"></div>
	</div>

	<div data-jc="panel__common.panel__if:detail;icon:box;title:Document editor;width:400;background:false">
		<div class="padding">
			<div data-jc="objecteditor__browser.detail__skip:ROW" class="m"></div>
			<div class="row">
				<div class="col-xs-8 m" data-jc="validation__browser.detail">
					<button name="submit" class="button button-small b exec" data-exec="browser/update" disabled><i class="fa fa-check-circle"></i>@(Update data)</button>
				</div>
				<div class="col-xs-4 m">
					<button class="button button-small button-silver b exec" data-exec="browser/cancel">@(Cancel)</button>
				</div>
			</div>
		</div>
	</div>

	<script>

		PLUGIN('browser', function(exports) {

			var rescape = /[|\n\r]/g;
			var runescape = /%7C|%0D|%0A/g;

			exports.detail = function(row) {
				SET('browser.detail', CLONE(row), true);
				SET('common.panel', 'detail');
			};

			exports.cancel = function() {
				SET('common.panel', '');
			};

			exports.update = function() {
				SET('common.panel', '');
				var index = browser.rows.findIndex('ROW', browser.detail.ROW);
				if (index !== -1) {
					browser.rows[index] = browser.detail;
					exports.element.SETTER('datagrid', 'refresh');
				}
			};

			exports.remove = function() {
				SETTER('confirm', 'show', '@(Are you sure you want to removed selected rows?)', ['"trash-o" @(Yes)', '@(Cancel)'], function(index) {

					if (index == 1)
						return;

					SETTER('loading', 'show');
					browser.checked.wait(function(row, next) {
						var index = browser.rows.indexOf(row);
						if (index !== -1)
							browser.rows.splice(index, 1);
						setTimeout(next, 10);
					}, function() {
						UPDATE('browser.rows');
						SETTER('loading', 'hide', 1000);
					});

				});
			};

			exports.save = function() {

				var REGBOOL = /":true/g;
				var JSONBOOL = '":true ';
				var rows = browser.rows;
				var data = [];

				if (browser.schema) {
					var tmp = '';
					for (var i = 0; i < browser.schema.length; i++) {
						var meta = browser.schema[i];
						tmp += (tmp ? '|' : '') + meta.name + ':' + (meta.type || 'string');
					}
					data.push(tmp);
				}

				for (var i = 0; i < rows.length; i++) {
					var row = CLONE(rows[i]);
					row.ROW = undefined;
					if (browser.schema)
						data.push(exports.stringifyTable(browser.schema, row));
					else
						data.push(JSON.stringify(row).replace(REGBOOL, JSONBOOL));
				}

				data.push('');

				var file = new File([data.join('\n')], browser.filename, { type: 'text/plain;charset=utf-8' });
				saveAs(file);
			};

			exports.download = function() {
				var file = new File([browser.binary.raw], browser.binary.name, { type: browser.binary.type });
				saveAs(file);
			};

			exports.process = function(files) {

				SET('browser.filename', files[0].name);

				var isfile = (/\.(nosql-binary|file$)/).test(browser.filename);
				var reader = new FileReader();

				reader.onload = function() {

					SET('browser.open', true);

					if (isfile) {
						var meta = PARSE(new TextDecoder("utf-8").decode(reader.result.slice(0, 2000)).trim());
						SET('browser.rows', null);
						meta.data = toBase64(reader.result.slice(2000));
						meta.raw = reader.result.slice(2000);
						if (meta.custom)
							meta.custom = JSON.stringify(meta.custom);
						SET('browser.binary', meta);
						return;
					}

					SET('browser.binary', null);

					if ((/\.table$/).test(browser.filename))
						exports.parseTable(reader.result);
					else
						exports.parse(reader.result);

					reader = null;
				};

				if (isfile)
					reader.readAsArrayBuffer(files[0]);
				else
					reader.readAsText(files[0]);
			};

			exports.parse = function(data) {
				var lines = data.split('\n');
				var tmp = {};
				var cols = [];
				var rows = [];

				for (var i = 0; i < lines.length; i++) {
					var line = lines[i].trim();

					// Removed item
					if (!line || line.substring[0] === '-')
						continue;

					var doc;

					try {
						doc = PARSE(line);
					} catch (e) {
						continue;
					}

					if (doc == null)
						continue;

					var keys = Object.keys(doc);

					for (var j = 0; j < keys.length; j++) {
						var key = keys[j];
						if (tmp[key])
							continue;
						tmp[key] = 1;
						var col = {};
						col.name = key;
						col.alignheader = 'center';
						col.alignfilter = 'center';
						col.template = '{{ {0} | nosqlrender }}'.format(key);
						cols.push(col);
					}

					rows.push(doc);
				}

				SET('browser.schema', null);
				exports.refresh(rows, cols);
			};

			exports.parseTableSchema = function(row) {
				var schema = [];
				row.split('|').forEach(function(item) {
					var a = item.split(':');
					schema.push({ name: a[0].trim(), type: a[1].trim() || 'string' });
				});
				return schema;
			};

			exports.parseTableRow = function(schema, row) {

				var obj = {};

				for (var i = 0; i < schema.length; i++) {
					var data = row.split('|');
					var meta = schema[i];
					var encode = data[0] === '*';
					var val = data[i + 1];
					switch (meta.type) {
						case 'string':
							if (encode && val)
								val = val.replace(runescape, exports.unescape);
							break;
						case 'number':
							val = +val;
							break;
						case 'boolean':
						case 'bool':
							val = val == '1' || val == 'true' || val == 'on';
							break;
						case 'date':
							val = val ? new Date(val.substring(10, 11) === 'T' ? val : +val) : null;
							break;
						case 'object':
							val = val ? PARSE(encode ? val.replace(runescape, exports.unescape) : val) : null;
							break;
					}
					obj[meta.name] = val;
				}

				return obj;
			};

			exports.parseTable = function(data) {

				var lines = data.split('\n');
				var cols = [];
				var rows = [];

				var schema = exports.parseTableSchema(lines[0]);

				for (var j = 0; j < schema.length; j++) {
					var col = {};
					col.name = schema[j].name;
					col.alignheader = 'center';
					col.alignfilter = 'center';
					col.template = '{{ {0} | nosqlrender }}'.format(col.name);
					cols.push(col);
				}

				for (var i = 1; i < lines.length; i++) {
					var line = lines[i].trim();

					// Removed item
					if (!line || line.substring[0] === '-')
						continue;

					var doc = exports.parseTableRow(schema, line);
					rows.push(doc);
				}

				SET('browser.schema', schema);
				exports.refresh(rows, cols);
			};

			exports.stringifyTable = function(schema, row) {
				var data = '';
				var plus = '+';

				for (var i = 0; i < schema.length; i++) {
					var meta = schema[i];
					var val = row[meta.name];
					switch (meta.type) {
						case 'string':
							val = val ? val : '';
							if (val && rescape.test(val)) {
								plus = '*';
								val = val.replace(rescape, exports.escape);
							}
							break;
						case 'number':
							val = (val || 0);
							break;
						case 'boolean':
						case 'bool':
							val = val == true ? '1' : '0';
							break;
						case 'date':
							val = val ? val.getTime() : '';
							break;
						case 'object':
							val = val ? JSON.stringify(val) : '';
							if (val && rescape.test(val)) {
								plus = '*';
								val = val.replace(rescape, exports.escape);
							}
							break;
					}
					data += '|' + val;
				}

				return plus + data;
			};

			exports.refresh = function(rows, cols) {
				FIND('datagrid', function(com) {
					com.rebind(cols);
					com.set(rows);
				});
				SET('browser.checked', EMPTYARRAY);
				SET('common.panel', '');
				AJAX('POST /api/stats/', { filename: browser.filename, rows: rows.length, cols: cols.length });
			};

			exports.unescape = function(c) {
				switch (c) {
					case '%0A':
						return '\n';
					case '%0D':
						return '\r';
					case '%7C':
						return '|';
				}
				return c;
			};

			exports.escape = function(c) {
				switch (c) {
					case '\n':
						return '%0A';
					case '\r':
						return '%0D';
					case '|':
						return '%7C';
				}
				return c;
			};

		});

		var params = READPARAMS();
		params.url && AJAX('GET /api/download/', { url: params.url }, function(response) {
			if (response) {
				SET('browser.filename', params.url);
				EXEC('browser/parse', response);
			}
		});

	</script>

	<script async src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>

</body>
</html>